-- Dev Kit Moving Box Test (CoreLX)
-- Purpose:
--   - Validate CoreLX compile -> ROM package -> Dev Kit Build+Run flow
--   - Validate embedded emulator rendering/input path in the Dev Kit
-- Controls:
--   - Arrow Keys / WASD: move the box
--   - Z: cycle palette color

asset BoxTile: tiles16
    hex
        -- Top half: color index 1 (0x11)
        11 11 11 11 11 11 11 11
        11 11 11 11 11 11 11 11
        11 11 11 11 11 11 11 11
        11 11 11 11 11 11 11 11
        11 11 11 11 11 11 11 11
        11 11 11 11 11 11 11 11
        11 11 11 11 11 11 11 11
        11 11 11 11 11 11 11 11
        -- Bottom half: color index 2 (0x22)
        22 22 22 22 22 22 22 22
        22 22 22 22 22 22 22 22
        22 22 22 22 22 22 22 22
        22 22 22 22 22 22 22 22
        22 22 22 22 22 22 22 22
        22 22 22 22 22 22 22 22
        22 22 22 22 22 22 22 22
        22 22 22 22 22 22 22 22

function Start()
    ppu.enable_display()

    -- Palette 1 defaults for visible box colors (RGB555)
    gfx.set_palette(1, 1, 0x7FFF)  -- White
    gfx.set_palette(1, 2, 0x03FF)  -- Cyan
    gfx.set_palette(1, 3, 0x7C1F)  -- Magenta
    gfx.set_palette(1, 4, 0x7FE0)  -- Yellow

    tile_base := gfx.load_tiles(ASSET_BoxTile, 0)

    box_x := 152
    box_y := 92
    color_mode := 0
    prev_buttons := 0
    last_frame := frame_counter()

    box := Sprite()
    sprite.set_pos(&box, box_x, box_y)
    box.tile = tile_base
    box.attr = SPR_PAL(1) | SPR_PRI(0)
    box.ctrl = SPR_ENABLE() | SPR_SIZE_16()

    wait_vblank()
    oam.write(0, &box)
    oam.flush()

    while true
        -- wait for next frame edge (wait_vblank() is level-based today and can
        -- advance multiple logic ticks during one visible frame)
        while frame_counter() == last_frame
            wait_vblank()
        last_frame = frame_counter()

        buttons := input.read(0)

        if (buttons & 0x01) != 0
            if box_y > 4
                box_y = box_y - 1

        if (buttons & 0x02) != 0
            if box_y < 180
                box_y = box_y + 1

        if (buttons & 0x04) != 0
            if box_x > 4
                box_x = box_x - 1

        if (buttons & 0x08) != 0
            if box_x < 300
                box_x = box_x + 1

        -- A button edge-trigger (Z / bit 4) cycles palette colors for the tile
        if (buttons & 0x10) != 0 and (prev_buttons & 0x10) == 0
            color_mode = color_mode + 1
            if color_mode >= 4
                color_mode = 0

            if color_mode == 0
                gfx.set_palette(1, 1, 0x7FFF)
                gfx.set_palette(1, 2, 0x03FF)
            if color_mode == 1
                gfx.set_palette(1, 1, 0x7C00)
                gfx.set_palette(1, 2, 0x03E0)
            if color_mode == 2
                gfx.set_palette(1, 1, 0x001F)
                gfx.set_palette(1, 2, 0x7FE0)
            if color_mode == 3
                gfx.set_palette(1, 1, 0x7C1F)
                gfx.set_palette(1, 2, 0x4210)

        prev_buttons = buttons

        sprite.set_pos(&box, box_x, box_y)
        oam.write(0, &box)
        oam.flush()
