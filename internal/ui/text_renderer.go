package ui

import (
	"github.com/veandco/go-sdl2/sdl"
)

// TextRenderer interface for text rendering
type TextRenderer interface {
	DrawText(renderer *sdl.Renderer, text string, x, y int32, color sdl.Color) error
	Close()
}

// NewTextRenderer tries to create an SDL_ttf renderer, returns error if not available
func NewTextRenderer(scale int) (TextRenderer, error) {
	// Try to use SDL_ttf if available
	// Import is conditional - if SDL_ttf is not installed, this will fail at compile time
	// We use build tags or runtime detection
	return newSDLTTFRenderer(scale)
}

// SimpleTextRenderer uses a clean bitmap font for readable text
type SimpleTextRenderer struct {
	scale int
}

// NewSimpleTextRenderer creates a simple bitmap font renderer
func NewSimpleTextRenderer(scale int) TextRenderer {
	return &SimpleTextRenderer{scale: scale}
}

// DrawText draws text using a simple, clean bitmap font
func (str *SimpleTextRenderer) DrawText(renderer *sdl.Renderer, text string, x, y int32, color sdl.Color) error {
	charWidth := int32(6 * str.scale)
	
	charX := x
	for _, char := range text {
		drawChar(renderer, char, charX, y, str.scale, color)
		charX += charWidth
	}
	return nil
}

// Close closes the text renderer (no-op for simple renderer)
func (str *SimpleTextRenderer) Close() {
	// Nothing to clean up
}

// drawChar draws a single character using a clean, readable bitmap font
func drawChar(renderer *sdl.Renderer, char rune, x, y int32, scale int, color sdl.Color) {
	// Clean, readable 6x10 bitmap font
	glyph, ok := getCharGlyph(char)
	if !ok {
		return
	}
	
	for row := 0; row < 10; row++ {
		bits := glyph[row]
		for col := 0; col < 6; col++ {
			if (bits>>uint(5-col))&1 != 0 {
				rect := &sdl.Rect{
					X: x + int32(col*scale),
					Y: y + int32(row*scale),
					W: int32(scale),
					H: int32(scale),
				}
				renderer.SetDrawColor(color.R, color.G, color.B, color.A)
				renderer.FillRect(rect)
			}
		}
	}
}

// getCharGlyph returns the bitmap data for a character (6x10 pixels)
func getCharGlyph(char rune) ([10]uint8, bool) {
	// Clean, readable font - each character is 6x10 pixels
	font := map[rune][10]uint8{
		'F': {0x3F, 0x30, 0x30, 0x3E, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00},
		'i': {0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x0C, 0x00, 0x00},
		'l': {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x0C, 0x00, 0x00},
		'e': {0x00, 0x00, 0x1E, 0x33, 0x3F, 0x30, 0x33, 0x1E, 0x00, 0x00},
		'E': {0x3F, 0x30, 0x30, 0x3E, 0x30, 0x30, 0x30, 0x3F, 0x00, 0x00},
		'm': {0x00, 0x00, 0x37, 0x3B, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00},
		'u': {0x00, 0x00, 0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x00, 0x00},
		'a': {0x00, 0x00, 0x1E, 0x03, 0x1F, 0x33, 0x33, 0x1F, 0x00, 0x00},
		't': {0x0C, 0x0C, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x06, 0x00, 0x00},
		'o': {0x00, 0x00, 0x1E, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x00, 0x00},
		'n': {0x00, 0x00, 0x37, 0x3B, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00},
		'V': {0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00, 0x00, 0x00},
		'w': {0x00, 0x00, 0x33, 0x33, 0x33, 0x1B, 0x1B, 0x0E, 0x00, 0x00},
		'D': {0x3E, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3E, 0x00, 0x00},
		'b': {0x30, 0x30, 0x3E, 0x33, 0x33, 0x33, 0x33, 0x3E, 0x00, 0x00},
		'g': {0x00, 0x00, 0x1F, 0x33, 0x33, 0x1F, 0x03, 0x1E, 0x00, 0x00},
		'H': {0x33, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00},
		'p': {0x00, 0x00, 0x3E, 0x33, 0x33, 0x3E, 0x30, 0x30, 0x00, 0x00},
		'S': {0x1E, 0x33, 0x30, 0x1E, 0x03, 0x03, 0x33, 0x1E, 0x00, 0x00},
		'r': {0x00, 0x00, 0x37, 0x3B, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00},
		'R': {0x3E, 0x33, 0x33, 0x3E, 0x36, 0x33, 0x33, 0x33, 0x00, 0x00},
		's': {0x00, 0x00, 0x1E, 0x30, 0x1E, 0x03, 0x33, 0x1E, 0x00, 0x00},
		' ': {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		':': {0x00, 0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x00, 0x00},
		'.': {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00, 0x00},
		'/': {0x03, 0x03, 0x06, 0x06, 0x0C, 0x0C, 0x18, 0x18, 0x00, 0x00},
		'-': {0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'0': {0x1E, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x00, 0x00},
		'1': {0x0C, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00},
		'2': {0x1E, 0x33, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x3F, 0x00, 0x00},
		'3': {0x1E, 0x33, 0x03, 0x0E, 0x03, 0x03, 0x33, 0x1E, 0x00, 0x00},
		'4': {0x06, 0x0E, 0x1E, 0x36, 0x3F, 0x06, 0x06, 0x06, 0x00, 0x00},
		'5': {0x3F, 0x30, 0x30, 0x3E, 0x03, 0x03, 0x33, 0x1E, 0x00, 0x00},
		'6': {0x1E, 0x33, 0x30, 0x3E, 0x33, 0x33, 0x33, 0x1E, 0x00, 0x00},
		'7': {0x3F, 0x03, 0x06, 0x0C, 0x0C, 0x18, 0x18, 0x18, 0x00, 0x00},
		'8': {0x1E, 0x33, 0x33, 0x1E, 0x33, 0x33, 0x33, 0x1E, 0x00, 0x00},
		'9': {0x1E, 0x33, 0x33, 0x33, 0x1F, 0x03, 0x33, 0x1E, 0x00, 0x00},
	}
	
	if glyph, ok := font[char]; ok {
		return glyph, true
	}
	return [10]uint8{}, false // Empty glyph for unknown characters
}
